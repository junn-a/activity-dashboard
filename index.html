<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .cell { width: 11px; height: 11px; border-radius: 2px; flex-shrink: 0; transition: all 0.2s; }
        .cell-none { background-color: #ebedf0; }
        .cell-active { background-color: #40c463; }
        .cell-filtered { opacity: 0.2; background-color: #ebedf0; border: none; }
        
        .day-label { font-size: 9px; color: #717171; height: 11px; line-height: 11px; }
        .month-labels { display: flex; font-size: 10px; color: #717171; margin-bottom: 4px; margin-left: 28px; }
        @media (max-width: 640px) { .scroll-container { overflow-x: auto; padding-bottom: 10px; } }
        
        .modal-fade { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .timeline-line { position: absolute; left: 15px; top: 0; bottom: 0; width: 2px; background: #e5e7eb; z-index: 0; }
    </style>
</head>
<body class="bg-[#f6f8fa] text-gray-800 font-sans p-4 md:p-10">

    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 tracking-tight" id="user-title">Activity Tracker</h1>
                <p class="text-sm text-gray-500" id="user-subtitle">Memuat data...</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                <button onclick="openUserModal()" class="text-xs font-semibold text-blue-600 bg-blue-50 px-3 py-1.5 rounded-full hover:bg-blue-100 transition">Ganti User</button>
                <button onclick="openConfirmReset()" class="text-xs font-semibold text-red-500 hover:text-red-700 transition">Reset Data</button>
            </div>
        </header>

        <div class="mb-6">
            <h3 class="text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">Filter by Tag</h3>
            <div id="tag-container" class="flex flex-wrap gap-2">
                </div>
        </div>

        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm mb-8">
            <h3 class="text-[11px] font-bold uppercase tracking-widest text-gray-400 mb-3">Input Kegiatan</h3>
            <div class="flex flex-col md:flex-row gap-3">
                <div class="bg-gray-50 border px-3 py-2 rounded text-sm text-gray-500 font-mono flex items-center md:w-48" id="display-date"></div>
                <input type="text" id="quick-input" placeholder="Gunakan #tag (misal: #sholat_berjamaah Di Masjid)" class="flex-1 p-2 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition">
                <button onclick="submitQuickLog()" class="bg-gray-900 text-white px-8 py-2 rounded-lg text-sm font-bold hover:bg-black transition shadow-sm">Simpan</button>
            </div>
        </div>

        <div class="scroll-container border border-gray-200 rounded-xl p-6 bg-white shadow-sm mb-10">
            <div class="calendar-wrapper w-[780px]">
                <div id="month-header" class="month-labels font-medium"></div>
                <div class="flex gap-2">
                    <div class="grid grid-rows-7 gap-[3px] pt-[1px]">
                        <div class="day-label italic"></div><div class="day-label">Sen</div><div class="day-label italic"></div><div class="day-label">Rab</div><div class="day-label italic"></div><div class="day-label">Jum</div><div class="day-label italic"></div>
                    </div>
                    <div id="calendar-grid" class="grid grid-flow-col grid-rows-7 gap-[3px]"></div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 bg-gray-50/50">
                <h2 class="text-sm font-bold text-gray-700 uppercase tracking-wider">Aktivitas Terakhir</h2>
            </div>
            <table class="min-w-full divide-y divide-gray-100">
                <tbody id="recent-list" class="divide-y divide-gray-100 text-sm"></tbody>
            </table>
        </div>
    </div>

    <div id="modal-overlay" class="hidden fixed inset-0 bg-black/60 backdrop-blur-[2px] flex items-center justify-center z-50 p-4">
        
        <div id="modal-timeline" class="hidden modal-fade bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md border overflow-hidden max-h-[80vh] flex flex-col">
            <p id="timeline-date" class="text-[10px] text-gray-400 mb-1 uppercase font-bold tracking-widest"></p>
            <h2 class="text-xl font-bold mb-4">Timeline Aktivitas</h2>
            
            <div class="relative flex-1 overflow-y-auto pr-2 mb-4" id="timeline-content">
                <div class="timeline-line"></div>
                </div>
            
            <button onclick="closeModals()" class="w-full py-3 bg-gray-100 rounded-xl font-bold hover:bg-gray-200 transition">Tutup</button>
        </div>

        <div id="modal-user" class="hidden modal-fade bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-6">Siapa Anda?</h2>
            <input type="text" id="user-input-field" placeholder="Nama Anda..." class="w-full p-3 border rounded-xl mb-4 outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="confirmUser()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Masuk</button>
        </div>

        <div id="modal-reset" class="hidden modal-fade bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-4">Reset Data?</h2>
            <p class="text-sm text-gray-500 mb-6">Semua riwayat akan hilang selamanya.</p>
            <div class="flex gap-3">
                <button onclick="closeModals()" class="flex-1 py-3 bg-gray-100 rounded-xl font-bold">Batal</button>
                <button onclick="executeReset()" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold">Hapus</button>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        let currentUser = params.get('user');
        let activeFilter = null;
        let selectedDate = '';

        const overlay = document.getElementById('modal-overlay');
        const grid = document.getElementById('calendar-grid');
        const recentList = document.getElementById('recent-list');
        const quickInput = document.getElementById('quick-input');
        const tagContainer = document.getElementById('tag-container');

        window.onload = () => {
            if (!currentUser) openUserModal();
            else setupApp();
        };

        function setupApp() {
            document.getElementById('user-title').innerText = `Log ${currentUser}`;
            document.getElementById('user-subtitle').innerText = `Dashboard 2026`;
            document.getElementById('display-date').innerText = new Date().toISOString().split('T')[0];
            init();
        }

        function getStorageKey() { return `multilogs_${currentUser}`; }
        function getLogs() { return JSON.parse(localStorage.getItem(getStorageKey())) || {}; }

        function init() {
            renderCalendar();
            renderRecent();
            renderTags();
        }

        // --- TAG SYSTEM ---
        function extractTags(text) {
            const tags = text.match(/#\w+/g);
            return tags ? tags : [];
        }

        function renderTags() {
            const logs = getLogs();
            const allTags = new Set();
            Object.values(logs).forEach(dayActivities => {
                dayActivities.forEach(act => {
                    extractTags(act.text).forEach(t => allTags.add(t));
                });
            });

            tagContainer.innerHTML = `<button onclick="setFilter(null)" class="text-xs px-3 py-1 rounded-full border ${!activeFilter ? 'bg-gray-900 text-white' : 'bg-white'}">Semua</button>`;
            allTags.forEach(tag => {
                const isSelected = activeFilter === tag;
                tagContainer.innerHTML += `<button onclick="setFilter('${tag}')" class="text-xs px-3 py-1 rounded-full border ${isSelected ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 hover:bg-gray-50'}">${tag}</button>`;
            });
        }

        function setFilter(tag) {
            activeFilter = tag;
            init();
        }

        // --- CALENDAR ---
        function renderCalendar() {
            grid.innerHTML = '';
            const logs = getLogs();
            const startOfYear = new Date(2026, 0, 1);
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            let lastMonth = -1;
            document.getElementById('month-header').innerHTML = '';

            for (let i = 0; i < 371; i++) {
                const d = new Date(startOfYear);
                d.setDate(startOfYear.getDate() + i);
                
                if (d.getMonth() !== lastMonth && i % 7 === 0) {
                    const mLabel = document.createElement('div');
                    mLabel.style.width = "61px";
                    mLabel.innerText = months[d.getMonth()];
                    document.getElementById('month-header').appendChild(mLabel);
                    lastMonth = d.getMonth();
                }

                const dateStr = d.toISOString().split('T')[0];
                const dayActivities = logs[dateStr] || [];
                
                let isMatch = dayActivities.length > 0;
                if (activeFilter && isMatch) {
                    isMatch = dayActivities.some(act => act.text.includes(activeFilter));
                }

                const cell = document.createElement('div');
                cell.className = `cell ${isMatch ? 'cell-active' : 'cell-none'} ${activeFilter && !isMatch ? 'cell-filtered' : ''} cursor-pointer hover:ring-2 ring-blue-400`;
                cell.onclick = () => openTimeline(dateStr);
                grid.appendChild(cell);
            }
        }

        // --- TIMELINE MODAL ---
        function openTimeline(date) {
            selectedDate = date;
            const logs = getLogs();
            const dayActivities = logs[date] || [];
            
            document.getElementById('timeline-date').innerText = date;
            const content = document.getElementById('timeline-content');
            content.innerHTML = '<div class="timeline-line"></div>';

            if (dayActivities.length === 0) {
                content.innerHTML += `<p class="ml-10 text-gray-400 text-sm italic py-4">Tidak ada aktivitas.</p>`;
            } else {
                dayActivities.sort((a,b) => a.time.localeCompare(b.time)).forEach((act, index) => {
                    content.innerHTML += `
                        <div class="relative ml-8 mb-6 group">
                            <div class="absolute -left-[22px] top-1.5 w-3 h-3 rounded-full bg-blue-500 border-2 border-white"></div>
                            <div class="flex justify-between items-start bg-gray-50 p-3 rounded-lg border group-hover:border-blue-300 transition">
                                <div>
                                    <span class="text-[10px] font-bold text-blue-600 block mb-1">${act.time}</span>
                                    <p class="text-sm font-medium text-gray-700">${act.text}</p>
                                </div>
                                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                    <button onclick="deleteActivity(${index})" class="text-red-400 hover:text-red-600">âœ•</button>
                                </div>
                            </div>
                        </div>`;
                });
            }
            
            overlay.classList.remove('hidden');
            document.getElementById('modal-timeline').classList.remove('hidden');
        }

        // --- CORE FUNCTIONS ---
        function submitQuickLog() {
            const text = quickInput.value.trim();
            if (!text) return;
            
            const logs = getLogs();
            const dateStr = new Date().toISOString().split('T')[0];
            const timeStr = new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }).replace('.', ':');
            
            if (!logs[dateStr]) logs[dateStr] = [];
            logs[dateStr].push({ time: timeStr, text: text });
            
            localStorage.setItem(getStorageKey(), JSON.stringify(logs));
            quickInput.value = '';
            init();
        }

        function deleteActivity(index) {
            const logs = getLogs();
            logs[selectedDate].splice(index, 1);
            if (logs[selectedDate].length === 0) delete logs[selectedDate];
            localStorage.setItem(getStorageKey(), JSON.stringify(logs));
            openTimeline(selectedDate); // Refresh timeline
            init(); // Refresh calendar & tags
        }

        function renderRecent() {
            recentList.innerHTML = '';
            const logs = getLogs();
            const all = [];
            Object.entries(logs).forEach(([date, activities]) => {
                activities.forEach(act => all.push({ date, ...act }));
            });
            
            all.sort((a, b) => (b.date + b.time).localeCompare(a.date + a.time)).slice(0, 5).forEach(item => {
                recentList.innerHTML += `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3 text-xs font-mono text-gray-400 w-40">${item.date} | ${item.time}</td>
                        <td class="px-5 py-3 font-semibold text-gray-700">${item.text}</td>
                    </tr>`;
            });
        }

        // Modals Toggle
        function openUserModal() { overlay.classList.remove('hidden'); document.getElementById('modal-user').classList.remove('hidden'); }
        function openConfirmReset() { overlay.classList.remove('hidden'); document.getElementById('modal-reset').classList.remove('hidden'); }
        function closeModals() { overlay.classList.add('hidden'); document.querySelectorAll('#modal-overlay > div').forEach(m => m.classList.add('hidden')); }
        function confirmUser() { const v = document.getElementById('user-input-field').value.trim(); if(v) window.location.search = `?user=${v.toLowerCase()}`; }
        function executeReset() { localStorage.removeItem(getStorageKey()); closeModals(); init(); }
    </script>
</body>
</html>

